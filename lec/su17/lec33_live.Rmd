---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.4
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
from datascience import *
import numpy as np

import matplotlib.pyplot as plt
plt.style.use('fivethirtyeight')
# %matplotlib inline

from ipywidgets import interact, interactive, fixed, interact_manual
import ipywidgets as widgets
```

## Linear regression

```{python}
def standard_units(any_numbers):
    "Convert any array of numbers to standard units."
    return (any_numbers - np.mean(any_numbers)) / np.std(any_numbers)  

def correlation(t, x, y):
    """Return the correlation coefficient (r) of two variables."""
    return np.mean(standard_units(t.column(x)) * standard_units(t.column(y)))

def slope(t, x, y):
    """The slope of ther regression line (original units)."""
    r = correlation(t, x, y)
    return r * np.std(t.column(y)) / np.std(t.column(x))

def intercept(t, x, y):
    """The intercept of the regression line (original units)."""
    return np.mean(t.column(y)) - slope(t, x, y) * np.mean(t.column(x))

def fit(table, x, y):
    """Return the height of the regression line at each x value."""
    a = slope(table, x, y)
    b = intercept(table, x, y)
    return a * table.column(x) + b
```

```{python}
lw = Table.read_table('http://inferentialthinking.com/notebooks/little_women.csv').move_to_start('Periods')
lw.show(3)
```

```{python}
shotput = Table.read_table('http://inferentialthinking.com/notebooks/shotput.csv')
shotput.show(3)
```

## Residuals

```{python}
lw.scatter(0, 1, fit_line=True)
```

```{python}
y = lw.column(1)
fitted = fit(lw, 0, 1)
residuals = y - fitted
```

```{python}
sum(residuals)
```

```{python}
np.mean(residuals**2)**0.5
```

## Residual Plot

```{python}
lw.with_column('residual', residuals).scatter(0, 2)
```

```{python}
def plot_residuals(t):
    t.scatter(0, 1, fit_line=True)
    y = t.column(1)
    fitted = fit(t, 0, 1)
    residuals = y - fitted
    print('Sum of residuals:', sum(residuals))
    print('RMSE:', np.mean(residuals**2)**0.5)
    t.with_column('Residual', residuals).scatter(0, 2)
```

```{python}
plot_residuals(shotput)
```

## Dugong

```{python}
dugong = Table.read_table('http://www.statsci.org/data/oz/dugongs.txt')
dugong.show(3)
```

```{python}
plot_residuals(dugong)
```

```{python}
us_women = Table.read_table('http://inferentialthinking.com/notebooks/us_women.csv')
us_women.show(3)
```

```{python}
correlation(us_women, 0, 1)
```

```{python}
plot_residuals(us_women)
```

## Variance

```{python}
def r_scatter(r):
    """
    Generate a scatter plot with a correlation approximately r
    and print variance ratios
    """
    plt.figure(figsize=(5,5))
    x = np.random.normal(0, 1, 2000)
    z = np.random.normal(0, np.sqrt(1-r**2), 2000)
    y = r*x + z
    
    fitted = r*x
    resid = y - fitted
    print('Var resid / var y      =', np.round(np.var(resid) / np.var(y), 2))
    print('Var fitted / var y     =', np.round(np.var(fitted) / np.var(y), 2))
    print('Var y                  =', np.round(np.var(y), 1))
    print('Var fitted + var resid =', np.round(np.var(fitted) + np.var(resid), 1))
    
    plt.scatter(x, y, c='gray')
    plt.scatter(x, fitted, c='dodgerblue')
    plt.xlim(-4, 4)
    plt.ylim(-4, 4)
    plt.show()
```

```{python}
_ = interact(r_scatter, r=(-1, 1, 0.1))
```

## Regression Model

```{python}
def draw_and_compare(true_slope, true_int, sample_size):
    x = np.random.normal(50, 5, sample_size)
    xlims = np.array([np.min(x), np.max(x)])
    errors = np.random.normal(0, 6, sample_size)
    y = (true_slope * x + true_int) + errors
    sample = Table().with_columns('x', x, 'y', y)

    sample.scatter(0, 1)
    plt.plot(xlims, true_slope*xlims + true_int, lw=2, color='green')
    plt.title('True Line, and Points Created')

    sample.scatter(0, 1)
    plt.title('What We Get to See')

    sample.scatter(0, 1, fit_line=True)
    plt.title('Regression Line: Estimate of True Line')

    sample.scatter(0, 1, fit_line=True)
    plt.plot(xlims, true_slope*xlims + true_int, lw=2, color='green')
    plt.title("Regression Line and True Line")
    
draw_and_compare(2, -5, 10)
```

```{python}
draw_and_compare(2, -5, 100)
```

```{python}
draw_and_compare(2, -5, 1000)
```

```{python}

```
